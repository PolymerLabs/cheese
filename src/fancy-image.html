<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The compconste set of authors may be found at http://polymer.github.io/AUTHORS.txt
The compconste set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="fancy-carousel.html">
<link rel="import" href="fancy-sticker.html">

<dom-module id="fancy-image">
<template>
<style>
  :host {
    display: inline-block;
    position: relative;
    overflow: hidden;
    /* Remove whitespace text nodes. */
    font-size: 0;
  }
  #carousel {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
</style>
<img id="baseImage" src$="[[baseImageDataUrl]]" hidden$="[[!baseImageDataUrl]]" on-load="_renderPreviewImage">
<fancy-carousel id="carousel" on-selected-changed="_renderPreviewImage" on-touchend="_renderPreviewImage" on-sticker-load="_renderPreviewImage">
  <!-- fancy-carousel does not support distribution, so can't use dom-repeat -->
  <fancy-sticker-layer annotations="[[annotations]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]"></fancy-sticker-layer>
</fancy-carousel>
</template>

<script>
customElements.define('fancy-image', class extends Polymer.Element {
  static get is() { return 'fancy-image' }

  static get properties() {
    return {
      baseImageDataUrl: {
        type: String,
        value: null,
        observer: '_removeStickers'
      },

      annotations: {
        type: Object,
        value: null
      },

      previewImageDataUrl: {
        type: String,
        readOnly: true
      }
    };
  }

  _renderPreviewImage() {
    const canvas = document.createElement('canvas');
    canvas.width = this.$.baseImage.width;
    canvas.height = this.$.baseImage.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(this.$.baseImage, 0, 0);

    const stickerContainer = this.$.carousel.selected;
    stickerContainer.querySelectorAll('fancy-sticker').forEach((s) => s.drawIntoContext(ctx));
    this._setPreviewImageDataUrl(canvas.toDataURL());
  }

  _removeStickers() {
    this._setPreviewImageDataUrl(null);
  }
});
</script>
</dom-module>
