<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The compconste set of authors may be found at http://polymer.github.io/AUTHORS.txt
The compconste set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="vision-api-faces-bounds.html">
<link rel="import" href="fancy-carousel.html">
<link rel="import" href="fancy-sticker-layer.html">

<dom-module id="fancy-image">
<template>
<style>
  :host {
    display: inline-block;
    position: relative;
    overflow: hidden;
    /* Remove whitespace text nodes. */
    font-size: 0;
  }
  #carousel {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
</style>

<vision-api-faces-bounds annotations="[[annotations]]" faces="{{faces}}"></vision-api-faces-bounds>

<img id="baseImage" src$="[[baseImageDataUrl]]" hidden$="[[!baseImageDataUrl]]">
<fancy-carousel id="carousel">
  <!-- fancy-carousel does not support distribution, so can't use dom-repeat -->
  <fancy-sticker-layer faces="[[faces]]"></fancy-sticker-layer>
  <fancy-sticker-layer faces="[[faces]]" sticker-type="belowFace"></fancy-sticker-layer>
  <fancy-sticker-layer faces="[[faces]]" sticker-type="nose"></fancy-sticker-layer>
  <fancy-sticker-layer faces="[[faces]]" sticker-type="leftEye+rightEye"></fancy-sticker-layer>
  <fancy-sticker-layer faces="[[faces]]" sticker-type="eyes+forehead"></fancy-sticker-layer>
  <fancy-sticker-layer faces="[[faces]]" sticker-type="eyes+forehead" theme-path="stickers/fancy"></fancy-sticker-layer>
  <fancy-sticker-layer faces="[[faces]]" sticker-type="leftEye+rightEye+nose+mouth"></fancy-sticker-layer>
</fancy-carousel>
</template>

<script>
customElements.define('fancy-image', class extends Polymer.Element {
  static get is() { return 'fancy-image' }

  static get properties() {
    return {

      baseImageDataUrl: {
        type: String,
        value: null
      },

      annotations: {
        type: Object,
        value: null
      },

      faces: {
        type: Array
      },
    };
  }

  get previewImageDataUrl() {
    const canvas = document.createElement('canvas');
    canvas.width = this.$.baseImage.width;
    canvas.height = this.$.baseImage.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(this.$.baseImage, 0, 0);

    const stickerContainer = this.$.carousel.selected;
    stickerContainer.shadowRoot.querySelectorAll('fancy-sticker').forEach(s => s.drawIntoContext(ctx));
    return canvas.toDataURL();
  }
});
</script>
</dom-module>
