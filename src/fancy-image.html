<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The compconste set of authors may be found at http://polymer.github.io/AUTHORS.txt
The compconste set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="fancy-carousel.html">
<link rel="import" href="fancy-sticker-layer.html">

<dom-module id="fancy-image">
<template>
<style>
  :host {
    display: inline-block;
    position: relative;
    overflow: hidden;
    /* Remove whitespace text nodes. */
    font-size: 0;
  }

  fancy-carousel,
  fancy-sticker-layer {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }

  img:not([visible]) {
    display: none;
  }
</style>

<img id="baseImage" src$="[[baseImageDataUrl]]" alt$="[[_computeImgAlt(annotations.labelAnnotations)]]" visible$="[[_isDefined(baseImageDataUrl)]]">
<fancy-carousel id="carousel">
  <!-- fancy-carousel does not support distribution, so can't use dom-repeat -->
  <fancy-sticker-layer annotations="[[annotations]]" random show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="leftEye+rightEye+nose+mouth+forehead" random show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="emotion" show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="belowFace" show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="nose" show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="leftEye+rightEye" show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="eyes+forehead" show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="eyes+forehead" theme-path="stickers/fancy" show-bounds="[[showBounds]]"></fancy-sticker-layer>
  <fancy-sticker-layer annotations="[[annotations]]" sticker-type="leftEye+rightEye+nose+mouth" show-bounds="[[showBounds]]"></fancy-sticker-layer>
</fancy-carousel>
</template>

<script>
customElements.define('fancy-image', class extends Polymer.Element {
  static get is() { return 'fancy-image' }

  static get properties() {
    return {

      baseImageDataUrl: {
        type: String
      },

      annotations: {
        type: Object
      },

      showBounds: {
        type: Boolean
      },

      showPreview: {
        type: Boolean,
        observer: '_showPreviewChanged'
      }
    };
  }

  get previewImageDataUrl() {
    const canvas = document.createElement('canvas');
    canvas.width = this.$.baseImage.width;
    canvas.height = this.$.baseImage.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(this.$.baseImage, 0, 0);

    this.$.carousel.selected.drawIntoContext(ctx);
    return canvas.toDataURL();
  }
  
  _computeImgAlt(labelAnnotations) {
    if (!labelAnnotations) return '';
    const res = [];
    labelAnnotations.every(label => {
      if (label.score >= .55) {
        res.push(label.description);
        return true;
      }
      // Stop if score is less than 55%.
      return false;
    });
    return res.join(',');
  }

  _isDefined(data) {
    return !!data;
  }

  _showPreviewChanged(show) {
    if (show) {
      this.$.baseImage.src = this.previewImageDataUrl;
      this.$.carousel.style.display = 'none';
    } else {
      this.$.baseImage.src = this.baseImageDataUrl;
      this.$.carousel.style.display = '';
    }
  }
});
</script>
</dom-module>
