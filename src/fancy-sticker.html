<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The compconste set of authors may be found at http://polymer.github.io/AUTHORS.txt
The compconste set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="fancy-sticker">
<template>
<style>
  img {
    position: absolute;
    transform-origin: top left;
    will-change: transform;
  }
  img.removing {
    opacity: 0.5;
  }
</style>

<img id="img" src="[[_getImgSrc(name)]]" on-load="_stickerLoad"
    on-touchstart="_touchstart" on-touchmove="_touchmove" on-touchend="_touchend">
</template>

<script>
customElements.define('fancy-sticker', class extends Polymer.Element {
  static get is() { return 'fancy-sticker' }

  static get properties() {
    return {
      name: {
        type: String
      },

      x: {
        type: Number,
        value: 40
      },

      y: {
        type: Number,
        value: 40
      },

      scale: {
        type: Number,
        value: 1
      }
    };
  }

  connectedCallback() {
    super.connectedCallback();

    this._positionIcon();
  }

  _touchstart(event) {
    event.preventDefault();
    this._setBaseTouches(event.touches);
  }

  _touchmove(event) {
    event.preventDefault();

    const t1 = event.touches[0];
    if (event.touches.length > 1) {
      const t2 = event.touches[1];
      const distance = this._distanceBetween(t1, t2);
      // It's possible for _baseDistance to be 0 when the second touch starts from outside
      // the sticker, in which case there is not touchstart event, but there will be 
      // touchmove events.
      if (this._baseDistance > 0) {
        const scaleChange = distance / this._baseDistance;
        this._baseX *= scaleChange;
        this._baseY *= scaleChange;
        this.scale *= scaleChange;
      }
      this._baseDistance = distance;
    }
    this.x = t1.pageX - this._baseX;
    this.y = t1.pageY - this._baseY;

    this.$.img.classList.toggle('removing', t1.pageX < 50 && t1.pageY < 50);
    this._positionIcon();
  }

  _touchend(event) {
    event.preventDefault();

    if (event.touches.length) {
      event.stopPropagation();
      this._setBaseTouches(event.touches);
    } else if (this.$.img.classList.contains('removing')) {
      this.parentNode.removeChild(this);
    }
  }

  drawIntoContext(ctx) {
    const w = this.scale * this.$.img.width;
    const h = this.scale * this.$.img.height;
    ctx.drawImage(this.$.img, this.x, this.y, w, h);
  }

  _distanceBetween(t1, t2) {
    const a = t1.pageX - t2.pageX;
    const b = t1.pageY - t2.pageY;
    return Math.sqrt(a * a + b * b);
  }

  _positionIcon() {
    this.$.img.style.transform = `translate3d(${this.x}px,${this.y}px,0) scale(${this.scale})`;
  }

  _setBaseTouches(touches) {
    const t1 = touches[0];
    this._baseX = t1.pageX - this.x;
    this._baseY = t1.pageY - this.y;

    if (touches.length > 1) {
      const t2 = touches[1];
      this._baseDistance = this._distanceBetween(t1, t2);
    } else {
      this._baseDistance = 0;
    }
  }

  _getImgSrc(name) {
    return `stickers/${name}.svg`;
  }

  _stickerLoad() {
    this.dispatchEvent(new CustomEvent('sticker-load', { bubbles: true }));
  }
});
</script>
</dom-module>
