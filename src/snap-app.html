<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The compconste set of authors may be found at http://polymer.github.io/AUTHORS.txt
The compconste set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="snap-app">

  <template>

    <style>

      :host {
        display: block;
      }

      :host([loading]) {
        pointer-events: none;
      }

      snap-scanner {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        will-change: transform;
        transform-origin: bottom right;
      }

      snap-scanner.download {
        animation: snap-fly-away 600ms ease-in-out forwards;
      }

      @keyframes snap-fly-away {
        0% {
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
        40% {
          transform: translateY(0) scale(1.1);
          filter: blur(0);
        }
        100% {
          transform: translateY(120vh) scale(0.2);
          filter: blur(10vmin);
        }
      }

      .download-icon {
        position: fixed;
        right: 0;
        bottom: 0;
        padding: 16px;
      }

      [hidden] {
        display: none !important;
      }

      input[type="file"] {
        display: none;
      }

      .camera-button {
        position: fixed;
        bottom: 24px;
        left: calc(50% - 36px);
        margin: 0 auto;
        width: 72px;
        height: 72px;
        border: 6px solid #FFF;
        border-radius: 50%;
        box-sizing: border-box;

        display: flex;
        align-items: center;
        justify-content: center;
      }

    </style>

    <slot></slot>

    <vision-api-image-annotations api-key="AIzaSyCG3rPxfQu1ntULMM4TUmIrQyxPEcJsZLk" image-data-url="[[imageDataUrl]]" last-annotations="{{annotations}}"
      loading="{{loading}}"></vision-api-image-annotations>

    
    <snap-scanner id="scanner" show="[[_isDefined(imageDataUrl)]]" scan="[[loading]]" scanning="{{scanning}}">
      <fancy-image id="fancyImage" base-image-data-url="[[imageDataUrl]]"></fancy-image>
      <svg hidden$="[[_shouldHideDownload(scanning, imageDataUrl)]]" class="download-icon" fill="#FFF" width="60" height="60" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" on-click="_download">
        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        <path d="M0 0h24v24H0z" fill="none"/>
      </svg>
    </snap-scanner>

    <label class="camera-button">
      <svg class="camera-icon" fill="#FFF" width="40" height="40" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
        <path d="M0 0h24v24H0V0z" fill="none"/>
        <path d="M12 17l1.25-2.75L16 13l-2.75-1.25L12 9l-1.25 2.75L8 13l2.75 1.25z"/>
      </svg>
      <input id="fileInput" type="file" accept="image/*" capture="user" on-change="_upload">
    </label>

  </template>

  <script>

    class SnapApp extends Polymer.Element {

      static get is() { return 'snap-app'; }

      static get properties() { return {

        loading: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        scanning: {
          type: Boolean,
          value: false
        },

        fileName: {
          type: String,
          value: null
        },

        imageDataUrl: {
          type: Object
        },

        annotations: {
          type: Object
        }

      }}

      static get observers() {
        return [
          '_annotationsChanged(annotations, scanning)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();

        requestAnimationFrame(() => {
          const lazyImports = document.createElement('link');
          lazyImports.rel = 'import';
          lazyImports.href = '/src/lazy-imports.html';
          document.head.appendChild(lazyImports);
        });
      }

      _upload(event) {
        const files = event.target.files;
        if (!files.length) {
          return;
        }
        this.fileName = files[0].name;
        window.loadImage(files[0], (canvas) => {
          this.imageDataUrl = canvas.toDataURL();
        }, {
          maxWidth: window.innerWidth,
          canvas: true,
          orientation: true
        });
        // Reset to allow uploads of the same file again.
        event.target.value = '';
      }

      _annotationsChanged(annotations, scanning) {
        if (!scanning && annotations && annotations.faceAnnotations) {
          annotations.faceAnnotations.forEach((face) => {
            const decreasingLikelihoods = ['VERY_LIKELY', 'LIKELY', 'POSSIBLE'];
            for (let i = 0; i < decreasingLikelihoods.length; ++i) {
              const currentLikelihood = decreasingLikelihoods[i];
              if (face.joyLikelihood === currentLikelihood) {
                this.$.fancyImage.addSticker('joy', face.boundingPoly);
                return;
              } else if (face.sorrowLikelihood === currentLikelihood) {
                this.$.fancyImage.addSticker('sorrow', face.boundingPoly);
                return;
              } else if (face.angerLikelihood === currentLikelihood) {
                this.$.fancyImage.addSticker('anger', face.boundingPoly);
                return;
              } else if (face.surpriseLikelihood === currentLikelihood) {
                this.$.fancyImage.addSticker('surprise', face.boundingPoly);
                return;
              }
            }
            this.$.fancyImage.addSticker('normal', face.boundingPoly);
          });
        }
      }
      
      _shouldHideDownload(scanning, data) {
        return scanning || !data;
      }

      _isDefined(data) {
        return !!data;
      }

      _download() {
        // Wait for cool animations to be done.
        this.$.scanner.classList.add('download');
        setTimeout(() => {
          const link = document.createElement('a');
          link.download = this.fileName;
          link.target = '_blank';
          link.href = this.$.fancyImage.previewImageDataUrl;
          link.click();
          this.imageDataUrl = null;
          this.$.scanner.classList.remove('download');
        }, 650);
      }
    }

    customElements.define(SnapApp.is, SnapApp);
  </script>

</dom-module>
