<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The compconste set of authors may be found at http://polymer.github.io/AUTHORS.txt
The compconste set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="snap-spinner.html">
<link rel="import" href="vision-api-image-annotations.html">

<dom-module id="snap-app">

  <template>

    <style>
       :host {
        display: block;
      }

       :host([loading]) {
        pointer-events: none;
      }

      #canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition-property: filter;
        transition-duration: 0.8s;
      }

       :host([loading]) #canvas {
        transition-duration: 0s;
        -webkit-filter: blur(50px);
        filter: blur(50px);
      }

      .tools {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        position: fixed;
        right: 0;
        bottom: 0;
        left: 0;
        height: 64px;
        padding: 0 16px;
      }

      .download-icon {
        padding: 4px;
      }

      snap-spinner {
        position: fixed;
        width: 80px;
        height: 60px;
        top: calc(50% - 30px);
        left: calc(50% - 40px);
      }

      [hidden] {
        display: none !important;
      }

      input[type="file"] {
        display: none;
      }

      .camera-button {
        position: fixed;
        bottom: 24px;
        left: calc(50% - 36px);
        margin: 0 auto;
        width: 72px;
        height: 72px;
        border: 6px solid #FFF;
        border-radius: 50%;
        box-sizing: border-box;

        display: flex;
        align-items: center;
        justify-content: center;
      }

      .camera-button::after {
        content: '';
        width: 52px;
        height: 52px;
        background-color: #FFF;
        border-radius: 50%;
      }
    </style>

    <slot></slot>

    <vision-api-image-annotations api-key="AIzaSyCG3rPxfQu1ntULMM4TUmIrQyxPEcJsZLk" image-data-url="[[_imageDataUrl]]" last-annotations="{{_annotations}}"
      loading="{{loading}}"></vision-api-image-annotations>

    <canvas id="canvas"></canvas>

    <label class="camera-button">
      <input id="fileInput" type="file" accept="image/*" capture="user" on-change="_upload">
    </label>
    <div class="tools" hidden$="[[!imageReady]]">
      <svg class="download-icon" fill="#FFF" width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" on-click="_download">
        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
        <path d="M0 0h24v24H0z" fill="none" />
      </svg>
    </div>

    <snap-spinner active active="[[loading]]" hidden$="[[!loading]]"></snap-spinner>

  </template>

  <script>
    class SnapApp extends Polymer.Element {

      static get is() {
        return 'snap-app';
      }

      static get properties() {
        return {

          loading: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },

          imageReady: {
            type: Boolean,
            value: false
          },

          _imageDataUrl: {
            type: Object
          },

          _annotations: {
            type: Object,
            observer: '_annotationsChanged'
          }

        };
      }

      _upload(event) {
        const fileInput = event.target;
        if (fileInput.files && fileInput.files.length > 0) {
          const reader = new FileReader();
          reader.addEventListener('load', () => {
            const dataUrl = reader.result;
            const img = new Image();
            img.addEventListener('load', () => {
              const context = this.$.canvas.getContext('2d');
              const w = window.innerWidth;
              const scale = img.width / w;
              const h = img.height / scale;
              this.$.canvas.setAttribute('width', w);
              this.$.canvas.setAttribute('height', h);
              context.clearRect(0, 0, this.$.canvas.width, this.$.canvas.height);
              context.drawImage(img, 0, 0, w, h);
              this._sendRequest();
            });
            img.setAttribute('src', dataUrl);
          });
          this.fileName = fileInput.files[0].name;
          reader.readAsDataURL(fileInput.files[0]);
        }
      }

      _sendRequest() {
        this._imageDataUrl = this.$.canvas.toDataURL();
      }

      // TODO: update this when integrating the stickers.
      _annotationsChanged(annotations) {
        setTimeout(() => this.imageReady = true);
      }

      _download() {
        // TODO: better way to download the image onto the device?
        const link = document.createElement("a");
        link.download = this.fileName;
        link.target = '_blank';
        link.href = this.$.canvas.toDataURL();
        link.click();
      }

    }

    customElements.define(SnapApp.is, SnapApp);
  </script>

</dom-module>